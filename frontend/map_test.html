<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AidSight Heat Map</title>
    

    <style>
        body { margin: 0; padding: 0; }
        /* 2. Make the map fill the screen */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Tooltip styling */
        .mapboxgl-popup-content {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: Arial, sans-serif;
            border-radius: 4px;
            padding: 10px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // Dynamically load Leaflet CSS/JS and PapaParse, then run the map logic
        (function () {
            function loadCSS(href) {
                return new Promise((res, rej) => {
                    if (document.querySelector(`link[href="${href}"]`)) return res();
                    const l = document.createElement('link');
                    l.rel = 'stylesheet';
                    l.href = href;
                    l.onload = res;
                    l.onerror = rej;
                    document.head.appendChild(l);
                });
            }
            function loadScript(src) {
                return new Promise((res, rej) => {
                    if (document.querySelector(`script[src="${src}"]`)) return res();
                    const s = document.createElement('script');
                    s.src = src;
                    s.onload = res;
                    s.onerror = rej;
                    document.head.appendChild(s);
                });
            }

            Promise.all([
                loadCSS('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'),
                loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'),
                loadScript('https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js')
            ]).then(init).catch(err => {
                console.error('Failed to load dependencies', err);
            });

            function init() {
                // create map
                const map = L.map('map', { zoomControl: true }).setView([20, 0], 2);

                // OpenStreetMap tiles (no API key)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                // Load CSV and GeoJSON in parallel
                const csvUrl = '../backend/data/misfit_final_analysis.csv';
                const geojsonUrl = 'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson';

                Promise.all([
                    fetch(csvUrl).then(r => r.ok ? r.text() : Promise.reject('CSV fetch failed')),
                    fetch(geojsonUrl).then(r => r.ok ? r.json() : Promise.reject('GeoJSON fetch failed'))
                ]).then(([csvText, geojson]) => {
                    const parsed = Papa.parse(csvText, { header: true, dynamicTyping: true, skipEmptyLines: true });
                    const rows = parsed.data;

                    // Build lookup by ISO3 from CSV (normalize keys)
                    const lookup = {};
                    rows.forEach(r => {
                        if (!r) return;
                        const iso = (r.Country_ISO3 || r.country_iso3 || r.ISO3 || r.iso3 || '').toString().trim();
                        if (!iso) return;
                        lookup[iso.toUpperCase()] = {
                            is_overlooked: String(r.is_overlooked).toLowerCase() === 'true' || r.is_overlooked === true,
                            funding_per_capita: (r.funding_per_capita === '' || r.funding_per_capita == null) ? NaN : Number(r.funding_per_capita),
                            in_need: r.In_Need || r.in_need || r.InNeed || r.inNeed || r.in_need_population || r.In_Need_population || r.In_Need
                        };
                    });

                    // Determine funding range (exclude NaN)
                    const fundVals = Object.values(lookup).map(v => v.funding_per_capita).filter(v => !isNaN(v));
                    const fundMin = fundVals.length ? Math.min(...fundVals) : 0;
                    const fundMax = fundVals.length ? Math.max(...fundVals) : 1;

                    // Helper: interpolate between two hex colors
                    function hexToRgb(hex) {
                        hex = hex.replace('#', '');
                        if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
                        const n = parseInt(hex, 16);
                        return [n >> 16, (n >> 8) & 255, n & 255];
                    }
                    function rgbToHex(r, g, b) {
                        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
                    }
                    function interpColor(v, aHex, bHex) {
                        const a = hexToRgb(aHex), b = hexToRgb(bHex);
                        return rgbToHex(
                            Math.round(a[0] + (b[0] - a[0]) * v),
                            Math.round(a[1] + (b[1] - a[1]) * v),
                            Math.round(a[2] + (b[2] - a[2]) * v)
                        );
                    }

                    // Color scale: low -> light yellow, high -> dark green
                    function colorForFunding(val) {
                        if (isNaN(val)) return '#eeeeee';
                        const t = fundMax === fundMin ? 0.5 : Math.max(0, Math.min(1, (val - fundMin) / (fundMax - fundMin)));
                        return interpColor(t, '#ffffcc', '#006837');
                    }

                    // Try to get ISO3 from geo feature properties via common keys
                    function featureISO3(props) {
                        if (!props) return undefined;
                        const keys = Object.keys(props);
                        const candidates = ['ISO_A3', 'ISO3', 'ISO_A3', 'iso_a3', 'ISO3_A3', 'ADM0_A3', 'adm0_a3', 'iso_a3_eh'];
                        for (const k of candidates) if (k in props) return (props[k] || '').toString().trim().toUpperCase();
                        // fallback: try any prop that looks like a 3-letter code
                        for (const k of keys) {
                            const v = (props[k] || '').toString().trim();
                            if (/^[A-Z]{3}$/.test(v)) return v;
                        }
                        return undefined;
                    }

                    // Style and interactions
                    function style(feature) {
                        const iso = featureISO3(feature.properties);
                        const data = iso ? lookup[iso] : null;
                        const overlooked = data && data.is_overlooked === true;
                        const fillColor = overlooked ? '#ff0000' : (data ? colorForFunding(data.funding_per_capita) : '#eeffe6');
                        return {
                            fillColor,
                            weight: 0.6,
                            opacity: 1,
                            color: '#444',
                            fillOpacity: 0.8
                        };
                    }

                    function highlightLayer(e) {
                        const layer = e.target;
                        layer.setStyle({
                            weight: 2,
                            color: '#222',
                            fillOpacity: 0.95
                        });
                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) layer.bringToFront();
                    }
                    function resetHighlight(e) {
                        geojsonLayer.resetStyle(e.target);
                    }
                    function onEachFeature(feature, layer) {
                        const iso = featureISO3(feature.properties) || 'N/A';
                        const data = iso in lookup ? lookup[iso] : null;
                        const inNeed = data && data.in_need != null ? data.in_need : 'N/A';
                        const funding = data && !isNaN(data.funding_per_capita) ? Number(data.funding_per_capita).toLocaleString(undefined, { maximumFractionDigits: 2 }) : 'N/A';
                        const overlooked = data && data.is_overlooked ? 'Yes' : 'No';

                        const popupHtml =
                            '<div style="font-family:Arial,sans-serif;line-height:1.3;">' +
                            '<strong>Country Code:</strong> ' + iso + '<br/>' +
                            '<strong>In_Need:</strong> ' + inNeed + '<br/>' +
                            '<strong>Funding per capita:</strong> ' + funding + '<br/>' +
                            '<strong>Overlooked:</strong> ' + overlooked +
                            '</div>';

                        layer.on({
                            mouseover: highlightLayer,
                            mouseout: resetHighlight
                        });
                        layer.bindPopup(popupHtml, { closeButton: false, offset: L.point(0, -2) });
                        layer.bindTooltip(iso, { permanent: false, direction: 'center', className: 'country-tooltip' });
                    }

                    const geojsonLayer = L.geoJson(geojson, {
                        style,
                        onEachFeature
                    }).addTo(map);

                    // Fit bounds to geojson
                    try {
                        map.fitBounds(geojsonLayer.getBounds(), { padding: [20, 20] });
                    } catch (e) {
                        // ignore if bounds invalid
                    }

                    // Simple legend for scale and overlooked
                    const legend = L.control({ position: 'bottomright' });
                    legend.onAdd = function () {
                        const div = L.DomUtil.create('div', 'info legend');
                        const grades = [fundMin, (fundMin + fundMax) / 2, fundMax];
                        let html = '<div style="background:#fff;padding:6px;border-radius:4px;font-family:Arial,Helvetica,sans-serif;font-size:12px;box-shadow:0 0 6px rgba(0,0,0,0.15)">';
                        html += '<div style="margin-bottom:6px"><strong>Funding per capita</strong></div>';
                        grades.forEach((g, i) => {
                            const color = colorForFunding(g);
                            html += '<div style="display:flex;align-items:center;margin-bottom:4px"><span style="width:18px;height:12px;background:' + color + ';display:inline-block;margin-right:8px;border:1px solid #999"></span>' + (isNaN(g) ? 'N/A' : Number(g).toLocaleString(undefined, { maximumFractionDigits: 2 })) + '</div>';
                        });
                        html += '<div style="margin-top:8px;"><div style="display:flex;align-items:center"><span style="width:18px;height:12px;background:#ff0000;display:inline-block;margin-right:8px;border:1px solid #999"></span>Overlooked: Yes</div></div>';
                        html += '</div>';
                        div.innerHTML = html;
                        return div;
                    };
                    legend.addTo(map);

                }).catch(err => {
                    console.error('Failed to load data', err);
                    alert('Failed to load map data. See console for details.');
                });
            }
        })();
    </script>
</body>
</html>